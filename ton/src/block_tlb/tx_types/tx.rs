use crate::block_tlb::*;
use crate::tlb_adapters::ConstLen;
use crate::tlb_adapters::TLBRef;
use crate::tlb_adapters::{DictKeyAdapterInto, DictValAdapterTLBRef, TLBHashMapE, TLBRefOpt};
use std::collections::HashMap;
use ton_lib_core::cell::{CellBuilder, CellParser, TonHash};
use ton_lib_core::errors::TonCoreError;
use ton_lib_core::traits::tlb::TLB;
use ton_lib_core::TLB;

// https://github.com/ton-blockchain/ton/blob/ed4682066978f69ffa38dd98912ca77d4f660f66/crypto/block/block.tlb#L291
#[derive(Default, Clone, Debug, PartialEq, TLB)]
#[tlb(prefix = 0b0111, bits_len = 4)]
pub struct Tx {
    pub account_addr: TonHash,
    pub lt: u64,
    pub prev_tx_hash: TonHash,
    pub prev_tx_lt: u64,
    pub now: u32,
    #[tlb(bits_len = 15)]
    pub out_msgs_cnt: u16,
    pub orig_status: AccountStatus,
    pub end_status: AccountStatus,
    #[tlb(adapter = "TLBRef")]
    pub msgs: TxMsgs,
    pub total_fees: CurrencyCollection,
    #[tlb(adapter = "TLBRef")]
    pub state_update: HashUpdate,
    #[tlb(adapter = "TLBRef")]
    pub descr: TxDescr,
}

#[derive(Default, Debug, Clone, PartialEq)]
pub struct TxMsgs {
    pub in_msg: Option<Msg>,
    pub out_msgs: Vec<Msg>,
}

impl TLB for TxMsgs {
    fn read_definition(parser: &mut CellParser) -> Result<Self, TonCoreError> {
        let in_msg = TLBRefOpt::<_>::new().read(parser)?;
        let mut out_msgs_map = TLBHashMapE::<DictKeyAdapterInto, DictValAdapterTLBRef, u32, _>::new(15).read(parser)?;
        let mut out_msgs = Vec::with_capacity(out_msgs_map.len());
        // it's important to keep the order
        for msg_index in 0..out_msgs_map.len() as u32 {
            let msg = match out_msgs_map.remove(&msg_index) {
                Some(msg) => msg,
                None => return Err(TonCoreError::TLBWrongData(format!("Missing out message with index {msg_index}"))),
            };
            out_msgs.push(msg);
        }
        Ok(Self { in_msg, out_msgs })
    }

    fn write_definition(&self, builder: &mut CellBuilder) -> Result<(), TonCoreError> {
        TLBRefOpt::<_>::new().write(builder, &self.in_msg)?;
        let out_msgs_map: HashMap<_, _> =
            self.out_msgs.iter().enumerate().map(|(i, msg)| (i as u32, msg.clone())).collect();
        TLBHashMapE::<DictKeyAdapterInto, DictValAdapterTLBRef, u32, _>::new(15).write(builder, &out_msgs_map)?;
        Ok(())
    }
}

#[cfg(test)]
mod tests {
    use super::*;
    use crate::block_tlb::{
        AccStatusChange, AccStatusChangeUnchanged, AccountStatusActive, Coins, ComputePhaseVMInfo, TrComputePhase,
        TrComputePhaseVM, TrStoragePhase, TxDescrTickTock,
    };
    use std::str::FromStr;
    use ton_lib_core::types::tlb_core::VarLen;

    #[test]
    fn test_block_tlb_tx_tick_tock() -> anyhow::Result<()> {
        let tx = Tx::from_boc_hex("b5ee9c72010206010001320003af734517c7bdf5187c55af4f8b61fdc321588c7ab768dee24b006df29106458d7cf000016e2cc89c18399602ce40fd84286bddb06f8bcc9fceb7e3027f9826c8985017f16cba12363cc000016e2cc89c18161fa4c700001408050401020530303403020069600000009600000004000600000000000519ae84f17b8f8b22026a975ff55f1ab19fde4a768744d2178dfa63bb533e107a409026bc009e42664e625a00000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000082721fb68f3dbf22da4d92562a5895d490994d960e83e2e82a05e9ff86f7e1cafb2812bfed72f3e7140856bfe23e76bd419a6de0a046c29fa08833ecc7dff85e1ffd000120")?;
        let expected = Tx {
            account_addr: TonHash::from_str("34517c7bdf5187c55af4f8b61fdc321588c7ab768dee24b006df29106458d7cf")?,
            lt: 25163350000003,
            prev_tx_hash: TonHash::from_str("99602ce40fd84286bddb06f8bcc9fceb7e3027f9826c8985017f16cba12363cc")?,
            prev_tx_lt: 25163350000001,
            now: 1643793520,
            out_msgs_cnt: 0,
            orig_status: AccountStatus::Active(AccountStatusActive),
            end_status: AccountStatus::Active(AccountStatusActive),
            msgs: TxMsgs {
                in_msg: None,
                out_msgs: Default::default(),
            },
            total_fees: CurrencyCollection::new(0u32),
            state_update: HashUpdate {
                old: TonHash::from_str("1fb68f3dbf22da4d92562a5895d490994d960e83e2e82a05e9ff86f7e1cafb28")?,
                new: TonHash::from_str("12bfed72f3e7140856bfe23e76bd419a6de0a046c29fa08833ecc7dff85e1ffd")?,
            },
            descr: TxDescr::TickTock(TxDescrTickTock {
                is_tock: true,
                storage_phase: TrStoragePhase {
                    storage_fees_collected: Coins::ZERO,
                    storage_fees_due: None,
                    status_change: AccStatusChange::Unchanged(AccStatusChangeUnchanged),
                },
                compute_phase: TrComputePhase::VM(Box::new(TrComputePhaseVM {
                    success: true,
                    msg_state_used: false,
                    account_activated: false,
                    gas_fees: Coins::ZERO,
                    compute_phase_vm_info: ComputePhaseVMInfo {
                        gas_used: VarLen::new(4914u32, 16),
                        gas_limit: VarLen::new(10000000u32, 24),
                        gas_credit: None,
                        mode: 0,
                        exit_code: 0,
                        exit_arg: None,
                        vm_steps: 48,
                        vm_init_state_hash: TonHash::from_str(
                            "0000000000000000000000000000000000000000000000000000000000000000",
                        )?,
                        vm_final_state_hash: TonHash::from_str(
                            "0000000000000000000000000000000000000000000000000000000000000000",
                        )?,
                    },
                })),
                action: Some(TrActionPhase {
                    success: false,
                    valid: true,
                    no_funds: true,
                    status_change: AccStatusChange::Unchanged(AccStatusChangeUnchanged {}),
                    total_fwd_fees: None,
                    total_action_fees: None,
                    result_code: 37,
                    result_arg: Some(2),
                    tot_actions: 3,
                    spec_actions: 0,
                    skipped_actions: 0,
                    msgs_created: 2,
                    action_list_hash: TonHash::from_str(
                        "8cd74278bdc7c59101354baffaaf8d58cfef253b43a2690bc6fd31dda99f083d",
                    )?,
                    tot_msg_size: StorageUsedShort {
                        cells: VarLen::new(2u32, 8),
                        bits: VarLen::new(1239u32, 16),
                    },
                }),
                aborted: true,
                destroyed: false,
            }),
        };
        assert_eq!(tx, expected);
        assert_eq!(
            tx.cell_hash()?,
            TonHash::from_str("0735F1ED2915B7D5E0D7861129CBDFF339E9038C45F61799ED9AA12E3106D342")?
        );
        let serial = tx.to_boc_hex()?;
        let parsed_back = Tx::from_boc_hex(&serial)?;
        assert_eq!(tx, parsed_back);
        Ok(())
    }

    #[test]
    fn test_block_tlb_tx_ordinal() -> anyhow::Result<()> {
        // https://tonviewer.com/transaction/cd4c4f0f3e7962b90c92f5f0c27967fd4468acfa15d4df50faf8d2704a489e0b
        let tx = Tx::from_boc_hex("b5ee9c720102220100070a0003b57949a19cfd6eb82bb5ff6573b11208c71abb9398411b3b4672f78a7e34ea706d9000030a49dab0285b78a4a3e91ae0ddf8c49983a554e010cc4764ccc990500728e8202f958c7fc40000030a3c2065f45679cb7df00054693b1668050401021904825a890327c89418686858110302006fc989d2d84c1a32240000000000040000000000041d33f5c45a08b114815d645d1af4523cb3f221d59424fe5228ab5c828568aeaa41104eac009e45618c204fb40000000000000000d900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008272edc0c091d2c05021d1493b2a4c266f6ac6f6faf6d88a47b05bc7d70b3121d085ad2e937c5b6dab2c4c8053b8c697409e310fc5f9c455346f9dd9df1a355b2e1b0201e00c060201dd09070101200800c748012934339fadd70576bfecae76224118e357727308236768ce5ef14fc69d4e0db30024bae441b2880a544cb3985c3b388ce2e840d084d28f283679267c8726d225f90ffe24340608235a000061493b56050ecf396fbe6a993b6d8000000000000000400101200a01b148012934339fadd70576bfecae76224118e357727308236768ce5ef14fc69d4e0db3002526867315d8639b77efa65b2ef84f52dab9a47871fa97a8f7c033575f7366ad5029b9270006120ef4000061493b56050ccf396fbec00b01667362d09c00000000000000005012a05f20080125d7220d944052a2659cc2e1d9c4671742068426947941b3c933e43936912fc90e02b1680125d7220ebaa477a4c50ab937088b600f1d397c4c3cdfbc350becd4e25ff43e610025268673f5bae0aed7fd95cec448231c6aee4e61046ced19cbde29f8d3a9c1b650327c8940065dc45a000061493b560508cf396fbfe00f0d01b1178d451900000000000000005012a05f20080125d7220d944052a2659cc2e1d9c4671742068426947941b3c933e43936912fc90024bae441b2880a544cb3985c3b388ce2e840d084d28f283679267c8726d225f91029b927030e0099259385618012934339d11465553b2f3e428ae79b0b1e2fd250b80784d4996dd44741736528ca0259f3a0f90024bae441b2880a544cb3985c3b388ce2e840d084d28f283679267c8726d225f9100203f9a011100187080129343398aec31cdbbf7d32d977c27a96d5cd23c38fd4bd47be019abafb9b356b001ece9afb55cc82c82739247aa35879be66afeb1502a81a72f2a982ec7625b5fb20110114ff00f4a413f4bcf2c80b120201621413001ba0f605da89a1f401f481f481a8610202cc1f15020120191602014818170083200835c87b51343e803e903e90350c0134c7e08405e3514654882ea0841ef765f784ee84ac7cb8b174cfcc7e800c04e81408f214013e809633c58073c5b3327b552000db3b51343e803e903e90350c01f4cffe803e900c145468549271c17cb8b049f0bffcb8b0a0823938702a8005a805af3cb8b0e0841ef765f7b232c7c572cfd400fe8088b3c58073c5b25c60063232c14933c59c3e80b2dab33260103ec01004f214013e809633c58073c5b3327b55200201581d1a01f53b51343e803e903e90350c0234cffe80145468017e903e9002fe911d3232c084b281f2fff27414d431c1551cdb48965c150804d50500f214013e809633c58073c5b33248a0079c7232c032c132c004bd003d0032c032407e910c6af8407e40006ab84061386c2c5c1d3232c0b281f2fff2741631c16c7cb8b0c2a01b01fefa0051a8a18208989680820898968012b608a18208e4e1c0a018a1278e385279a018a182107362d09cc8cb1f5230cb3f58fa025007cf165007cf16c9718010c8cb0524cf165006fa0215cb6a14ccc971fb00102410239710491038375f04e225d70b01c30023c200b093356c21e30d03c85004fa0258cf1601cf16ccc9ed541c00428210d53276db708010c8cb055008cf165004fa0216cb6a12cb1f12cb3fc972fb0001f300f4cffe803e90087c007b51343e803e903e90350c144da8548ab1c17cb8b04a30bffcb8b0951d009c150804d50500f214013e809633c58073c5b33248a0079c7232c032c132c004bd003d0032c0325481be910c6af8407e40006ab84061386c2c5c1d3232c0b281f2fff274013e903d010c7e800835d27080201e00d8f2e2c4778018c8cb055008cf1670fa0217cb6b17cc8210178d4519c8cb1f19cb3f5007fa0222cf165006cf1624fa025003cf16c95005cc2291729171e25008a812a08208e4e1c0aa008208989680a0a014bcf2e2c504c98040fb004130c85004fa0258cf1601cf16ccc9ed540201d4212000113e910c1c2ebcb8536000c30831c02497c138007434c0c05c6c2544d7c0fc03783e903e900c7e800c5c75c87e800c7e800c1cea6d0000b4c7e08403e29fa954882ea54c4d167c02b8208405e3514654882ea58c511100fc02f80d60841657c1ef2ea4d67c033817c12103fcbc20")?;
        let expected = Tx {
            account_addr: TonHash::from_str("949a19cfd6eb82bb5ff6573b11208c71abb9398411b3b4672f78a7e34ea706d9")?,
            lt: 53483578000005,
            prev_tx_hash: TonHash::from_str("b78a4a3e91ae0ddf8c49983a554e010cc4764ccc990500728e8202f958c7fc40")?,
            prev_tx_lt: 53479893000005,
            now: 1738323935,
            out_msgs_cnt: 2,
            orig_status: AccountStatus::Active(AccountStatusActive {}),
            end_status: AccountStatus::Active(AccountStatusActive {}),
            msgs: TxMsgs {
                in_msg: Some(Msg::from_boc_hex("b5ee9c72010216010004c10002b1680125d7220ebaa477a4c50ab937088b600f1d397c4c3cdfbc350becd4e25ff43e610025268673f5bae0aed7fd95cec448231c6aee4e61046ced19cbde29f8d3a9c1b650327c8940065dc45a000061493b560508cf396fbfe0030101b1178d451900000000000000005012a05f20080125d7220d944052a2659cc2e1d9c4671742068426947941b3c933e43936912fc90024bae441b2880a544cb3985c3b388ce2e840d084d28f283679267c8726d225f91029b92703020099259385618012934339d11465553b2f3e428ae79b0b1e2fd250b80784d4996dd44741736528ca0259f3a0f90024bae441b2880a544cb3985c3b388ce2e840d084d28f283679267c8726d225f9100203f9a005040187080129343398aec31cdbbf7d32d977c27a96d5cd23c38fd4bd47be019abafb9b356b001ece9afb55cc82c82739247aa35879be66afeb1502a81a72f2a982ec7625b5fb20050114ff00f4a413f4bcf2c80b060201620807001ba0f605da89a1f401f481f481a8610202cc13090201200d0a0201480c0b0083200835c87b51343e803e903e90350c0134c7e08405e3514654882ea0841ef765f784ee84ac7cb8b174cfcc7e800c04e81408f214013e809633c58073c5b3327b552000db3b51343e803e903e90350c01f4cffe803e900c145468549271c17cb8b049f0bffcb8b0a0823938702a8005a805af3cb8b0e0841ef765f7b232c7c572cfd400fe8088b3c58073c5b25c60063232c14933c59c3e80b2dab33260103ec01004f214013e809633c58073c5b3327b5520020158110e01f53b51343e803e903e90350c0234cffe80145468017e903e9002fe911d3232c084b281f2fff27414d431c1551cdb48965c150804d50500f214013e809633c58073c5b33248a0079c7232c032c132c004bd003d0032c032407e910c6af8407e40006ab84061386c2c5c1d3232c0b281f2fff2741631c16c7cb8b0c2a00f01fefa0051a8a18208989680820898968012b608a18208e4e1c0a018a1278e385279a018a182107362d09cc8cb1f5230cb3f58fa025007cf165007cf16c9718010c8cb0524cf165006fa0215cb6a14ccc971fb00102410239710491038375f04e225d70b01c30023c200b093356c21e30d03c85004fa0258cf1601cf16ccc9ed541000428210d53276db708010c8cb055008cf165004fa0216cb6a12cb1f12cb3fc972fb0001f300f4cffe803e90087c007b51343e803e903e90350c144da8548ab1c17cb8b04a30bffcb8b0951d009c150804d50500f214013e809633c58073c5b33248a0079c7232c032c132c004bd003d0032c0325481be910c6af8407e40006ab84061386c2c5c1d3232c0b281f2fff274013e903d010c7e800835d27080201200d8f2e2c4778018c8cb055008cf1670fa0217cb6b17cc8210178d4519c8cb1f19cb3f5007fa0222cf165006cf1624fa025003cf16c95005cc2291729171e25008a812a08208e4e1c0aa008208989680a0a014bcf2e2c504c98040fb004130c85004fa0258cf1601cf16ccc9ed540201d4151400113e910c1c2ebcb8536000c30831c02497c138007434c0c05c6c2544d7c0fc03783e903e900c7e800c5c75c87e800c7e800c1cea6d0000b4c7e08403e29fa954882ea54c4d167c02b8208405e3514654882ea58c511100fc02f80d60841657c1ef2ea4d67c033817c12103fcbc20")?), // TODO
                out_msgs: vec![
                    Msg::from_boc_hex("b5ee9c720101030100e10001b148012934339fadd70576bfecae76224118e357727308236768ce5ef14fc69d4e0db3002526867315d8639b77efa65b2ef84f52dab9a47871fa97a8f7c033575f7366ad5029b9270006120ef4000061493b56050ccf396fbec00101667362d09c00000000000000005012a05f20080125d7220d944052a2659cc2e1d9c4671742068426947941b3c933e43936912fc9020099259385618012934339d11465553b2f3e428ae79b0b1e2fd250b80784d4996dd44741736528ca0259f3a0f90024bae441b2880a544cb3985c3b388ce2e840d084d28f283679267c8726d225f910")?,
                    Msg::from_boc_hex("b5ee9c720101010100660000c748012934339fadd70576bfecae76224118e357727308236768ce5ef14fc69d4e0db30024bae441b2880a544cb3985c3b388ce2e840d084d28f283679267c8726d225f90ffe24340608235a000061493b56050ecf396fbe6a993b6d800000000000000040")?,
                ],
            },
            total_fees: CurrencyCollection::new(4839603u32),
            state_update: HashUpdate {
                old: TonHash::from_str("edc0c091d2c05021d1493b2a4c266f6ac6f6faf6d88a47b05bc7d70b3121d085")?,
                new: TonHash::from_str("ad2e937c5b6dab2c4c8053b8c697409e310fc5f9c455346f9dd9df1a355b2e1b")?,
            },
            descr: TxDescr::Ord(TxDescrOrd {
                credit_first: false,
                storage_phase: Some(TrStoragePhase {
                    storage_fees_collected: Coins::new(2410u32),
                    storage_fees_due: None,
                    status_change: AccStatusChange::Unchanged(AccStatusChangeUnchanged{}),
                }),
                credit_phase: Some(TrCreditPhase {
                    due_fees_collected: None,
                    credit: CurrencyCollection::new(211755600u32),
                }),
                compute_phase: TrComputePhase::VM(Box::new(TrComputePhaseVM {
                    success: true,
                    msg_state_used: false,
                    account_activated: false,
                    gas_fees: Coins::new(4408000u32),
                    compute_phase_vm_info: ComputePhaseVMInfo {
                        gas_used: VarLen::new(11020u32, 16),
                        gas_limit: VarLen::new(529389u32, 24),
                        gas_credit: None,
                        mode: 0,
                        exit_code: 0,
                        exit_arg: None,
                        vm_steps: 217,
                        vm_init_state_hash: TonHash::from_str("0000000000000000000000000000000000000000000000000000000000000000")?,
                        vm_final_state_hash: TonHash::from_str("0000000000000000000000000000000000000000000000000000000000000000")?,
                    },
                })),
                action: Some(TrActionPhase {
                    success: true,
                    valid: true,
                    no_funds: false,
                    status_change: AccStatusChange::Unchanged(AccStatusChangeUnchanged{}),
                    total_fwd_fees: Some(Coins::new(1287600u32)),
                    total_action_fees: Some(Coins::new(429193u32)),
                    result_code: 0,
                    result_arg: None,
                    tot_actions: 2,
                    spec_actions: 0,
                    skipped_actions: 0,
                    msgs_created: 2,
                    action_list_hash: TonHash::from_str("0e99fae22d04588a40aeb22e8d7a291e59f910eaca127f291455ae4142b45755")?,
                    tot_msg_size: StorageUsedShort {
                        cells: VarLen::new(4u32, 8),
                        bits: VarLen::new(2517u32, 16),
                    },
                }),
                aborted: false,
                bounce: None,
                destroyed: false,
            }),
        };
        assert_eq!(tx, expected);
        assert_eq!(
            tx.cell_hash()?,
            TonHash::from_str("CD4C4F0F3E7962B90C92F5F0C27967FD4468ACFA15D4DF50FAF8D2704A489E0B")?
        );
        let serial = tx.to_boc_hex()?;
        let parsed_back = Tx::from_boc_hex(&serial)?;
        assert_eq!(tx, parsed_back);
        Ok(())
    }

    #[test]
    fn test_tx_9b7f973ac5e6a89c5ae3f6e986af5e6723f0298da219407afb39c9ef7c9352ef() -> anyhow::Result<()> {
        let tx = Tx::from_boc_hex("b5ee9c7201021a0100044a0003b572857bdf1ed7104d7d1c322e08f3b730dca9fe4f8abc7ff5a73d23f3c2a6c7ec1000014c012b30b01db6e6bef8edbc032cc47fff0839cbaa80f4761fc4407804b0d54732bb1c0a518000014c012577d83618856180002477c79028050401020f0c40461ab442c4400302006fc987a1204c145840000000000002000000000002c02f43991d8b2b6fcd5f70a7e14fd5d9da33b774def7741d91db16b9a4b781064050174c009d42c4e3138800000000000000001d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020008272b8cb33e034a8bfc1ecaf17f3a28131eaceba9348892bf85538e283a87550d402bfa047253b23d66835809070746a8fb3adcda563fb05bc0d4e9a1a6082eb14920201e008060101df0700bb480050af7be3dae209afa38645c11e76e61b953fc9f1578ffeb4e7a47e7854d8fd83000a15ef7c7b5c4135f470c8b823cedcc372a7f93e2af1ffd69cf48fcf0a9b1fb054094d0ded3c061458600000298025661604c310ac300507f454c002df880050af7be3dae209afa38645c11e76e61b953fc9f1578ffeb4e7a47e7854d8fd82119b8d0af3551672b1251ad29c2ae353bbf6187b6caae6babf52299f5f22cd0599c1951230e83128abf29ecac664daf80235fcb6622832862866ffac96f21f5260f0000017cfc8225ac68b55f3f80b090101c00a0043d01d1c2f610107a1a0abcc4e5fd9c1f15149fd34ab30482fd6d9d05ba16066d57560142402671115889b65652707f0ab10d8838340c7a888d4a6d6f8abb1320836c1634300068aed5320e30320c0ffe30220c0fee302f20b170d0c19028aed44d0d749c301f86621db3cd300019f810200d71820f90158f842f910f2a8ded33f01f84321b9f2b420f8238103e8a882081b7740a0b9f2b4f863d31f01db3cf8476ef27c100e0262ed44d0d749c301f86622d0d70b03a93800dc21c700209f3021d70d1ff2bc21c00020926c21dedfe30201db3cf8476ef27c140e02282082100a0fe8a9bae30220821068b55f3fbae302120f027830f8426ee300f846f273d1f800f82870c8cf8580ca0073cf40ce8d0480000000000000000000000000000507f454c0cf16c9810080fb00db3c7ff86710150216ed44d0d749c2018a8e80e21611012e70ed44d0f40588f86a8040f40ef2bdd70bfff86270f86319032630f846f2e04cf8426ee300d1db3cdb3c7ff8671613150072f84a20c8cc2101cc2101ccccc9f86af82870c8cf8580ca0073cf40ce8d0480000000000000000000000000000507f454c0cf16c9810080fb00027af846f2e04cf8426ee3008d0890801c52cadbcc81c8e6906459edafbdc9b71081994e92d387e139e6acb69cb20003d0c8ce806fcf40c98100a0fb00db3c16150022f84af843f842c8cbffcb3fcf83ccc9ed540024ed44d0d3ffd33fd30031d4d1f86af863f862020af4a420f4a119180014736f6c20302e34392e300000")?;
        assert_eq!(
            tx.account_addr,
            TonHash::from_str("2857bdf1ed7104d7d1c322e08f3b730dca9fe4f8abc7ff5a73d23f3c2a6c7ec1")?
        );
        assert_eq!(
            tx.cell_hash()?,
            TonHash::from_str("9b7f973ac5e6a89c5ae3f6e986af5e6723f0298da219407afb39c9ef7c9352ef")?
        );
        Ok(())
    }

    #[test]
    fn test_tx_aa9ca4bad904121dbc01db9526e172b49c7880d2a54fc5b8a7feee177c14ee33() -> anyhow::Result<()> {
        // https://tonviewer.com/transaction/aa9ca4bad904121dbc01db9526e172b49c7880d2a54fc5b8a7feee177c14ee33
        let tx = Tx::from_boc_hex("b5ee9c720102770100147e0003b572abf61973ca0a8490a64c4916bebfeae1a7045ceeb1b6f4e52b913e459f7b87b00002937ec18fa410756641985e9fea09baae3a4134fb34a486201799fca507ff383ab4113bd7b0100002937eb9ee84165f6db8e000146e96de0805040102170c420900bebc20186e96dd110302005bc00000000000000000000000012d452da449e50b8cf7dd27861f146122afe1b546bb8b70fc8216f0c614139f8e04009c43bc2b0d40000000000000000148000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000082728a6b30a651f00953fe9e2cc8b5b3c6e194eb1caf44be8b6fc80ddccf1980b9a5887fb9f09b4dac4a0047f4ab6084eb7a3bb3dd7719bb483cf408d0dc98c8a5060101a00601b348009109f72d3469f6f9ff2b44d726b58f09e126ad7ed576830fd8aa1a90ce139927000aafd865cf282a12429931245afaffab869c1173bac6dbd394ae44f9167dee1ed00bebc2000803c0b3620000526fd7b7e284cbedb6f4c00704993523881f0000000000000000a66fc77a4e821f4c129f912bc6644439d1ac63dd9b6f580cd1e94e2b5f7dccf8cacea7b04ed9405d653a230b52aac60ff91331bb0e878e9a487f7daa8c7be315c06d3724081248fe2a8c42614d68d12aac795123b0f0f08723ca54701bec967057c65bc7b934c40007a66fc77a4e821f4c129f912bc6644439d1ac63dd9b6f580cd1e94e2b5f7dccf8000000001b09094603bf9e1b33a424d7d7593a6ca3ffb83e5522e6428d85d33e8994f96a44a2a13b0c016f0a245b9023afe2ffffff1100ffffffff0000000000000000022451230000000165c334120000286f923dbb0402245120601a19160b2455cc26aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaac236870bdb78c3697e11100d0c28480101b20e36a3b36a4cdee601106c642e90718b0a58daf200753dbb3189f956b494b6000122bf000128c257f5000817706000050df243e6d0880001437c112edc38112280fde9cf40a0c85bf0f71835129709df1dbf902ef3cef1cd6e1c50478343e54d32299afe0de28a0ebc3b62f2b88763cc0c35640be1756cb61d4e36eccf11e26272d0be0f0e28480101fd99c10104b498a45bd1c30433496f3178a3060b3fc45c29615c27349a1689b30011284801019a92f0a65c9b1f4270b218a593ced06a6d24419c39af0bcda3422bf1b3a4ead6001a284801018138e3372827ff81e5a98f41ba062a4052a780c579ff6e11d57203ee16be4e2700112103d040122201c0151301db5013e99de0112289180001437c9173c6000001437c9173c6c3d6b8b525832e8dc440d0d7961eec1144afcbe540caa079966f7c2bcd36a5e1e5bd8636c59f2700884001e2902a2a7c5b589073fc76f582d4bbff52f4949d9840000040d4fe0000000000000000112289032e19a06a1400134af19aabd21dcd65002028480101f320fd1f53a51f843a1f4dbdabd1673b8d79370a24c3341be1fa06868ba62d20000122330000000000000000ffffffffffffffff819e03fe7d1eba482828181728480101dc9e1ac7d5a3b499da8b6d0b3f00e22b532f75684d5d63b4e9566799d20453fd001c28480101a5a7d24057d8643b2527709d986cda3846adcb3eddc32d28ec21f69e17dbaaef0001284801011667641019e9dd09a298c6d4eab1e1bba2355753a99b7d31243b6c42efc1a4dc016e284801018a0ebc4b269be153abc0e9fb87cab259c090efa4f4d33fb125268263f6719f680001094603a66fc77a4e821f4c129f912bc6644439d1ac63dd9b6f580cd1e94e2b5f7dccf800161c241011ef55aaffffff1122211e1d284801018f98cf4eaa2989c1abcb2366a7a8ae57c6d570a095d766d064d811c50b3b28c600072a8a04a8bf744b6d4d98dd5e5beaeefd2055eef9ad734034dff100f4d21e95bdc1c935bf9e1b33a424d7d7593a6ca3ffb83e5522e6428d85d33e8994f96a44a2a13b0c016f016f201f688c0103bf9e1b33a424d7d7593a6ca3ffb83e5522e6428d85d33e8994f96a44a2a13b0c1a19b8b7f86e3fe862006c1ea6efab91393c668ca39ff753b99597865ec69fd4016f0014688c0103a8bf744b6d4d98dd5e5beaeefd2055eef9ad734034dff100f4d21e95bdc1c935328148a7197e88d36c73482b77a4642c21d5a3b7833ff1ec2023b1746544b6eb016f0014284801012c5b49e84ed5a2d81f8c36d856e86424e73a33200f4cb2a9d90fcf0ee6c1cc56000301a09bc7a987000000000401022451230000000100ffffffff000000000000000065c334120000286f923dbb000000286f923dbb04b86e5cc400081770022451200224501fc400000005000000000000002e2300980000286f921f368402245122f9279cbc992ce04141a46dcbf95179a539a3bf0f19c5ff5151ce1acd04cbd58d9c209bd21923a5de79f35b9ade10e4d2c22a6fdb54cfb13c31936bdb0022dafa12674bf31a6b15281583a87f3ea90ca7baa6aefb888f6d1b800cbe29a283ab23c7d60008c00cacea7b04ed9405d653a230b52aac60ff91331bb0e878e9a487f7daa8c7be315226889a432e199f900000a1be474bad0c1340292502a58004998802c174a3e2eb400e6c96fd6abfb4ba30b014f757c425b3b6c78ba3def4d0012a05c234b3dec5686cd8befd922011475a61187d4bc17c516cdb02145f5da1cc000000000000000000000001970ccfca282601677038d7ea4c6800065af3107a40005174876e8000000000000000000000000000034bc00000000000076a700000000000076a700827009d801fd2b2c1b0de9638f907eb23492e10eb015cf33b88d088cad5b702837e2aadbe1003fa5658361bd2c71f20fd646925c21d602b9e67711a11195ab6e0506fc555b7c0000000038b3973f8064004b20014062d79883d20000000020114ff00f4a413f4bcf2c80b2a0201622c2b00fba0df8de003e008e1f047f087f09f41732661f0ab3bf047f087f0a141732661f0adbdc5f08a4351024e215209f083f085f087f089f08bf08df08ff093f095f097f099f09bf09df09ff0a1f0a3f0a5f0a7f0a9f0abf0ac2228222c22282226222a22262224222822242222222622222220222422201e22221e1c22201caa3b0202cd2e2d0071d387c11fc21e1804bfc21fc28d05b046f7c2250db04fc22fc2a5400d4411806f05b59d3b2000054827c2390d07c33fc2400d07c347c11fc324020120302f005d4f84af849c8f845fa02f846fa02f847fa02f848fa02cb0fc9f844f843c8f841cf16f842cf16cb3fcb3fccccc9ed548020120323100f33b51343e90007e187e90007e18b4cfc07e18f4cfc07e193500743e80007e197e80007e19be80007e19fe80007e1a34c3cc3e1a750c3e1abe12b43e80007e1afe80007e1b3e80007e1b74cfc07e1bb4cfc07e1bf4cfc07e1c34cfc07e1c750c343e90007e1cbe90007e1cf4cfc07e1d34c3c07e1d74c3cc3e1da003d90cc8b5d27087e4c0b4c7e4c09c0078807e1dc835d2708fe4b4cfe49c0078807e1e00b41d35c87e900c3e1e7c007e15e084067422e2aea3cc0c3e15e08407acc1da2ea3a8be15e0841d6bc46aaea3857e167e1071c17cb8af7e800c1c3e1196286d827e19b8c3b8c378c37c00a036353301fe31f859f842c705f2e2bdf823f843f84ea0bef2e2c082100ee6b280bef2e2c1f845f00470f823f843f84fa0b99b30f8555210a8812710a9048e15f823f843f850a0b99b30f8565210a8812710a904dee2f849c8f842cf16cb0f58fa0201fa02f847fa02f848fa02c9f858821023e0924ec8cb1fcb3ff852cf16f853cf16ccc934006e718018c8cb05f841cf1682100bebc200fa02cb6accc971fb00708010c8cb05f842cf1621fa02cb6ac9810082fb0070f86570f86770f86800b8f859f841c705f2e2bdfa0030f004f843c822fa02f845f846a0fa02cb3ff847fa02f848fa02c9f849f85882102c570e27c8cb1fcb3ff852cf16f842cf16cb0fccc9718018c8cb05f841cf1670fa02cb6accc98040fb00f84601a0f86600f8f857820b65aa20ba8e6bf859f841c705f2e2bdfa003070f84622a1b609f866f84cf845a121b60820c2009ff004f84521a0f865f823f86370f868de5cbc8e33f849f858821071885e93c8cb1fcb3ff852cf16f842cf16cb0f59a1fa02c9718018c8cb05f841cf1670fa02cb6accc98040fb00915be29530840ff2f0e219463c5eebc769076e8f55bfb239d1c69b13088a4b8e8fcdfc9e848617a252e923e5001a037db935542d719081d4ebcc2ec19ddbe23277aa6ef55aa1e39af87511eff6227c01d338235b9023afe2ffffff1101000000008000000000000000027d33bc0000000165c3340d0000286f922e78d802245120206c3a3921d9800001002000000060b00e4149948c0c81bc73c8b6300a128ba6694eda18e19410000286f9200b20402245120f15b1ab07b52f36e9455d07f3bbaeaeb816fa8624539d4040fc632b80359686ced6506f6a195c77261a59c7b47f0c277e05ca7947a2affec9f5a76c8d686c8a783c22138206f1cf22d8c0284a303b3c23135040de39e45b180509466b3d3c28480101bb06f3506745c5f6a6239d132a70b38439cb60ff95f62e45261ba12e844e889b00012313010299ec5c523a20acb8403f3e28480101ad57660aa9d96ef8477829d1a127963b0009a006126c46ff8183902609cbf1a4000128480101fdbbed5496b6556c9a90e289e70af7f60f2a4a9e3f963965525af8966ef964b001bd231301002f2af595dc0c853842414328480101f2f6fe016b51fb4e9b072d395f6e45dccd98ce6f1fbdd8f8a4d9051255eafd2801ce231100f07dd44eef15b3186a4443284801018abfab6d5739a7257d8f42f800d602e206fa344b5ef81fad6dba5f3a5c3dea410000221100ebee32c9f0560e68464528480101f2df4c577de71e407fb39e4d505b231adebe62dd308cc573fadf599b983ffe9d0065221100e2c4703c14120f486947221100e2857544c815648849482848010194261c3324c8cc35ff057611acf28187f4a7226beecab589a1d97e3791185eb80182221100e2628b741aab22c8684a220f00cae3ebbf094ba8674b220f00c4a7013b7fd3284d4c2848010166422de0d702df9f7cf7313b3df3dc61bb70ebd4bacc02aa4a89434d37d40d840061220f00c269edc1b112284f4e28480101ac81e80417e6a67be41ec090987b76072e34e8b3f5a4da7d103595bc6f213590001c220f00c10db9deb35c086650220f00c06d27874d03086551220d00b5bac0a80ae86452220d00ad1961518e08545328480101c32d351a62bb8df50ca3a4124c5d702742d7070845c5134e65d3044664632e200016220d00a541f522c5086355220d00a1b8f2227f885756284801016fe4ca7f2fd9996c9f60c7caf4e24f454602bc050f3d63531318b5b5548aa2910011220d00a0c363afed886258220d00a02c1c6061c85a592848010120b1c091c3fc81f969ca06e6720937d01377137c85a7534a29f13e263a04b3cb000e220b0089042730885c5b28480101d6ea177916d37bfd138f5d2111ee8cc29f02b776cd7c125b75e69ae7a25462f2000e22030008615d22030008605e218fba7609db280baca744616a5558c1ff22663761d0f1d3490fefb5518f7c62a007409cc34aeafce4b16ef579a752ad76803359a8c0d1dd62bb44a30cb2c39816b80001437c8e975a0c5f284801014bf31a6b15281583a87f3ea90ca7baa6aefb888f6d1b800cbe29a283ab23c7d60008284801013df0d5ae3c38e22cf11948609fd55e8d8c5751a5403835cb5854298bc07e912e0008284801014ab97878e707f6b7a6b66f80061e2a91c771e7c8d70363225b61862b708dd148000828480101d5f9f1bc6f5da130c2b22add929709f90a10d9bd7a060404776049183b534046000f28480101d8b6cca382ed037e921699461d90180000169b579a04c79829eb38eb947692090013284801012ccf4b7628e9ef3a81fd08a149df277b1f4c9cb373bf046ff668dc659b28109700172848010183c56d32cb572d19475384c2555dfaeda60e09df90e968592270b7058458c842001a28480101e16094e54cc07625daeb7ab01b2121f89b83883198ff0ac51356d629e49c162d001a284801012ca267bada1fe173a095ee83825158560f8a561cfa79eac126104d7fca444843001f284801015b0eb0ea082af45f1f0057576551d4920527d7272ae9272978a631785f45140f002a284801015d65d1c9dcd43cd4b9cb4b286622b6511e6c0ac8d894cce2cf0c3c6b7fde4e7e00ef2848010195ea62fad5502dd374c45b514f97aad280f42a01e20f69dcbba85475757b173a00ec28480101cdf8d708767621acc0f47543982ba574efb683dbe88bb1fb29758d00937edd4c01be28480101880edce964d5939a4baecf08bcec926d26cfdfdc4c7e82e524144847a0ad65eb00150946037ad716a4b065d1b8881a1af2c3dd822895f97ca819540f32cdef8579a6d4bc3c001f6e241011ef55aaffffff117473706f28480101639633e000afda58a8a6fe8683dda20ee9b9a03d07cb46424d66ba9aecbdc75000192a8a04ecf42a8d40d8a410ddc50b0b98425408e3e606c41ac05db9c90e8197db2a2c137db935542d719081d4ebcc2ec19ddbe23277aa6ef55aa1e39af87511eff6227c01d301d37271688c01037db935542d719081d4ebcc2ec19ddbe23277aa6ef55aa1e39af87511eff6227c177f5ba97c50ca4c1e7cd8cc5cdc6b9086b0e38ab15ab94036c6eebe46b2f74101d3001d688c0103ecf42a8d40d8a410ddc50b0b98425408e3e606c41ac05db9c90e8197db2a2c131fdf26006b5ea2aaa0786b51eac252d5a428c18fc1c2c55a98fc75b3a1e8f89301d3001c284801012bf865c8703e0c3bf380fce8bd7e34d58fdaaf57d17203625338ff91e2d6d4d0000302a09bc7a987000000008001027d33bc000000010100000000800000000000000065c3340d0000286f922e78c00000286f922e78d8ac97745d00081a9f022451200224501fc400000005000000000000002e767500980000286f921f369c027d33bb863fdf6f8b28aa8dde268c2bd7d53f743508299135872dc08595529511c3f469c61f3d34b73e081fef5af0c33c660293a6ef93b86ba149f8d6b07bab494d3bf500980000286f9200b20402245120f15b1ab07b52f36e9455d07f3bbaeaeb816fa8624539d4040fc632b80359686ced6506f6a195c77261a59c7b47f0c277e05ca7947a2affec9f5a76c8d686c8a7")?;
        let expected = Tx {
            account_addr: TonHash::from_str("2abf61973ca0a8490a64c4916bebfeae1a7045ceeb1b6f4e52b913e459f7b87b")?,
            lt: 45320161000001,
            prev_tx_hash: TonHash::from_str("0756641985e9fea09baae3a4134fb34a486201799fca507ff383ab4113bd7b01")?,
            prev_tx_lt: 45320153000001,
            now: 1710676878,
            out_msgs_cnt: 0,
            orig_status: AccountStatusActive.into(),
            end_status: AccountStatusActive.into(),
            msgs: TxMsgs {
                in_msg: Some(Msg::from_boc_hex("b5ee9c72010271010013470001b348009109f72d3469f6f9ff2b44d726b58f09e126ad7ed576830fd8aa1a90ce139927000aafd865cf282a12429931245afaffab869c1173bac6dbd394ae44f9167dee1ed00bebc2000803c0b3620000526fd7b7e284cbedb6f4c00104993523881f0000000000000000a66fc77a4e821f4c129f912bc6644439d1ac63dd9b6f580cd1e94e2b5f7dccf8cacea7b04ed9405d653a230b52aac60ff91331bb0e878e9a487f7daa8c7be315c067311e021248fe2a8c42614d68d12aac795123b0f0f08723ca54701bec967057c65bc7b934c40007a66fc77a4e821f4c129f912bc6644439d1ac63dd9b6f580cd1e94e2b5f7dccf8000000001503094603bf9e1b33a424d7d7593a6ca3ffb83e5522e6428d85d33e8994f96a44a2a13b0c016f04245b9023afe2ffffff1100ffffffff0000000000000000022451230000000165c334120000286f923dbb040224512060141310052455cc26aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaac236870bdb78c3697e0b0a070628480101b20e36a3b36a4cdee601106c642e90718b0a58daf200753dbb3189f956b494b6000122bf000128c257f5000817706000050df243e6d0880001437c112edc38112280fde9cf40a0c85bf0f71835129709df1dbf902ef3cef1cd6e1c50478343e54d32299afe0de28a0ebc3b62f2b88763cc0c35640be1756cb61d4e36eccf11e26272d0be090828480101fd99c10104b498a45bd1c30433496f3178a3060b3fc45c29615c27349a1689b30011284801019a92f0a65c9b1f4270b218a593ced06a6d24419c39af0bcda3422bf1b3a4ead6001a284801018138e3372827ff81e5a98f41ba062a4052a780c579ff6e11d57203ee16be4e2700112103d0400c2201c00f0d01db5013e99de0112289180001437c9173c6000001437c9173c6c3d6b8b525832e8dc440d0d7961eec1144afcbe540caa079966f7c2bcd36a5e1e5bd8636c59f2700884001e2902a2a7c5b589073fc76f582d4bbff52f4949d9840000040d4fe0000000000000000112289032e19a06a0e00134af19aabd21dcd65002028480101f320fd1f53a51f843a1f4dbdabd1673b8d79370a24c3341be1fa06868ba62d20000122330000000000000000ffffffffffffffff819e03fe7d1eba482828121128480101dc9e1ac7d5a3b499da8b6d0b3f00e22b532f75684d5d63b4e9566799d20453fd001c28480101a5a7d24057d8643b2527709d986cda3846adcb3eddc32d28ec21f69e17dbaaef0001284801011667641019e9dd09a298c6d4eab1e1bba2355753a99b7d31243b6c42efc1a4dc016e284801018a0ebc4b269be153abc0e9fb87cab259c090efa4f4d33fb125268263f6719f680001094603a66fc77a4e821f4c129f912bc6644439d1ac63dd9b6f580cd1e94e2b5f7dccf8001616241011ef55aaffffff111c1b1817284801018f98cf4eaa2989c1abcb2366a7a8ae57c6d570a095d766d064d811c50b3b28c600072a8a04a8bf744b6d4d98dd5e5beaeefd2055eef9ad734034dff100f4d21e95bdc1c935bf9e1b33a424d7d7593a6ca3ffb83e5522e6428d85d33e8994f96a44a2a13b0c016f016f1a19688c0103bf9e1b33a424d7d7593a6ca3ffb83e5522e6428d85d33e8994f96a44a2a13b0c1a19b8b7f86e3fe862006c1ea6efab91393c668ca39ff753b99597865ec69fd4016f0014688c0103a8bf744b6d4d98dd5e5beaeefd2055eef9ad734034dff100f4d21e95bdc1c935328148a7197e88d36c73482b77a4642c21d5a3b7833ff1ec2023b1746544b6eb016f0014284801012c5b49e84ed5a2d81f8c36d856e86424e73a33200f4cb2a9d90fcf0ee6c1cc56000301a09bc7a987000000000401022451230000000100ffffffff000000000000000065c334120000286f923dbb000000286f923dbb04b86e5cc400081770022451200224501fc400000005000000000000002e1d00980000286f921f368402245122f9279cbc992ce04141a46dcbf95179a539a3bf0f19c5ff5151ce1acd04cbd58d9c209bd21923a5de79f35b9ade10e4d2c22a6fdb54cfb13c31936bdb0022dafa12674bf31a6b15281583a87f3ea90ca7baa6aefb888f6d1b800cbe29a283ab23c7d60008c00cacea7b04ed9405d653a230b52aac60ff91331bb0e878e9a487f7daa8c7be315226889a432e199f900000a1be474bad0c1340231f02a58004998802c174a3e2eb400e6c96fd6abfb4ba30b014f757c425b3b6c78ba3def4d0012a05c234b3dec5686cd8befd922011475a61187d4bc17c516cdb02145f5da1cc000000000000000000000001970ccfca222001677038d7ea4c6800065af3107a40005174876e8000000000000000000000000000034bc00000000000076a700000000000076a700821009d801fd2b2c1b0de9638f907eb23492e10eb015cf33b88d088cad5b702837e2aadbe1003fa5658361bd2c71f20fd646925c21d602b9e67711a11195ab6e0506fc555b7c0000000038b3973f8064004b20014062d79883d20000000020114ff00f4a413f4bcf2c80b24020162262500fba0df8de003e008e1f047f087f09f41732661f0ab3bf047f087f0a141732661f0adbdc5f08a4351024e215209f083f085f087f089f08bf08df08ff093f095f097f099f09bf09df09ff0a1f0a3f0a5f0a7f0a9f0abf0ac2228222c22282226222a22262224222822242222222622222220222422201e22221e1c22201caa3b0202cd28270071d387c11fc21e1804bfc21fc28d05b046f7c2250db04fc22fc2a5400d4411806f05b59d3b2000054827c2390d07c33fc2400d07c347c11fc3240201202a29005d4f84af849c8f845fa02f846fa02f847fa02f848fa02cb0fc9f844f843c8f841cf16f842cf16cb3fcb3fccccc9ed5480201202c2b00f33b51343e90007e187e90007e18b4cfc07e18f4cfc07e193500743e80007e197e80007e19be80007e19fe80007e1a34c3cc3e1a750c3e1abe12b43e80007e1afe80007e1b3e80007e1b74cfc07e1bb4cfc07e1bf4cfc07e1c34cfc07e1c750c343e90007e1cbe90007e1cf4cfc07e1d34c3c07e1d74c3cc3e1da003d90cc8b5d27087e4c0b4c7e4c09c0078807e1dc835d2708fe4b4cfe49c0078807e1e00b41d35c87e900c3e1e7c007e15e084067422e2aea3cc0c3e15e08407acc1da2ea3a8be15e0841d6bc46aaea3857e167e1071c17cb8af7e800c1c3e1196286d827e19b8c3b8c378c37c00a0302f2d01fe31f859f842c705f2e2bdf823f843f84ea0bef2e2c082100ee6b280bef2e2c1f845f00470f823f843f84fa0b99b30f8555210a8812710a9048e15f823f843f850a0b99b30f8565210a8812710a904dee2f849c8f842cf16cb0f58fa0201fa02f847fa02f848fa02c9f858821023e0924ec8cb1fcb3ff852cf16f853cf16ccc92e006e718018c8cb05f841cf1682100bebc200fa02cb6accc971fb00708010c8cb05f842cf1621fa02cb6ac9810082fb0070f86570f86770f86800b8f859f841c705f2e2bdfa0030f004f843c822fa02f845f846a0fa02cb3ff847fa02f848fa02c9f849f85882102c570e27c8cb1fcb3ff852cf16f842cf16cb0fccc9718018c8cb05f841cf1670fa02cb6accc98040fb00f84601a0f86600f8f857820b65aa20ba8e6bf859f841c705f2e2bdfa003070f84622a1b609f866f84cf845a121b60820c2009ff004f84521a0f865f823f86370f868de5cbc8e33f849f858821071885e93c8cb1fcb3ff852cf16f842cf16cb0f59a1fa02c9718018c8cb05f841cf1670fa02cb6accc98040fb00915be29530840ff2f0e219463c5eebc769076e8f55bfb239d1c69b13088a4b8e8fcdfc9e848617a252e923e5001a037db935542d719081d4ebcc2ec19ddbe23277aa6ef55aa1e39af87511eff6227c01d332235b9023afe2ffffff1101000000008000000000000000027d33bc0000000165c3340d0000286f922e78d8022451202066343321d9800001002000000060b00e4149948c0c81bc73c8b6300a128ba6694eda18e19410000286f9200b20402245120f15b1ab07b52f36e9455d07f3bbaeaeb816fa8624539d4040fc632b80359686ced6506f6a195c77261a59c7b47f0c277e05ca7947a2affec9f5a76c8d686c8a783622138206f1cf22d8c0284a30353623135040de39e45b1805094665373628480101bb06f3506745c5f6a6239d132a70b38439cb60ff95f62e45261ba12e844e889b00012313010299ec5c523a20acb83a393828480101ad57660aa9d96ef8477829d1a127963b0009a006126c46ff8183902609cbf1a4000128480101fdbbed5496b6556c9a90e289e70af7f60f2a4a9e3f963965525af8966ef964b001bd231301002f2af595dc0c85383c3b3d28480101f2f6fe016b51fb4e9b072d395f6e45dccd98ce6f1fbdd8f8a4d9051255eafd2801ce231100f07dd44eef15b318643e3d284801018abfab6d5739a7257d8f42f800d602e206fa344b5ef81fad6dba5f3a5c3dea410000221100ebee32c9f0560e68403f28480101f2df4c577de71e407fb39e4d505b231adebe62dd308cc573fadf599b983ffe9d0065221100e2c4703c14120f486341221100e2857544c815648843422848010194261c3324c8cc35ff057611acf28187f4a7226beecab589a1d97e3791185eb80182221100e2628b741aab22c86244220f00cae3ebbf094ba86145220f00c4a7013b7fd32847462848010166422de0d702df9f7cf7313b3df3dc61bb70ebd4bacc02aa4a89434d37d40d840061220f00c269edc1b11228494828480101ac81e80417e6a67be41ec090987b76072e34e8b3f5a4da7d103595bc6f213590001c220f00c10db9deb35c08604a220f00c06d27874d03085f4b220d00b5bac0a80ae85e4c220d00ad1961518e084e4d28480101c32d351a62bb8df50ca3a4124c5d702742d7070845c5134e65d3044664632e200016220d00a541f522c5085d4f220d00a1b8f2227f885150284801016fe4ca7f2fd9996c9f60c7caf4e24f454602bc050f3d63531318b5b5548aa2910011220d00a0c363afed885c52220d00a02c1c6061c854532848010120b1c091c3fc81f969ca06e6720937d01377137c85a7534a29f13e263a04b3cb000e220b008904273088565528480101d6ea177916d37bfd138f5d2111ee8cc29f02b776cd7c125b75e69ae7a25462f2000e220300085b57220300085a58218fba7609db280baca744616a5558c1ff22663761d0f1d3490fefb5518f7c62a007409cc34aeafce4b16ef579a752ad76803359a8c0d1dd62bb44a30cb2c39816b80001437c8e975a0c59284801014bf31a6b15281583a87f3ea90ca7baa6aefb888f6d1b800cbe29a283ab23c7d60008284801013df0d5ae3c38e22cf11948609fd55e8d8c5751a5403835cb5854298bc07e912e0008284801014ab97878e707f6b7a6b66f80061e2a91c771e7c8d70363225b61862b708dd148000828480101d5f9f1bc6f5da130c2b22add929709f90a10d9bd7a060404776049183b534046000f28480101d8b6cca382ed037e921699461d90180000169b579a04c79829eb38eb947692090013284801012ccf4b7628e9ef3a81fd08a149df277b1f4c9cb373bf046ff668dc659b28109700172848010183c56d32cb572d19475384c2555dfaeda60e09df90e968592270b7058458c842001a28480101e16094e54cc07625daeb7ab01b2121f89b83883198ff0ac51356d629e49c162d001a284801012ca267bada1fe173a095ee83825158560f8a561cfa79eac126104d7fca444843001f284801015b0eb0ea082af45f1f0057576551d4920527d7272ae9272978a631785f45140f002a284801015d65d1c9dcd43cd4b9cb4b286622b6511e6c0ac8d894cce2cf0c3c6b7fde4e7e00ef2848010195ea62fad5502dd374c45b514f97aad280f42a01e20f69dcbba85475757b173a00ec28480101cdf8d708767621acc0f47543982ba574efb683dbe88bb1fb29758d00937edd4c01be28480101880edce964d5939a4baecf08bcec926d26cfdfdc4c7e82e524144847a0ad65eb00150946037ad716a4b065d1b8881a1af2c3dd822895f97ca819540f32cdef8579a6d4bc3c001f68241011ef55aaffffff116e6d6a6928480101639633e000afda58a8a6fe8683dda20ee9b9a03d07cb46424d66ba9aecbdc75000192a8a04ecf42a8d40d8a410ddc50b0b98425408e3e606c41ac05db9c90e8197db2a2c137db935542d719081d4ebcc2ec19ddbe23277aa6ef55aa1e39af87511eff6227c01d301d36c6b688c01037db935542d719081d4ebcc2ec19ddbe23277aa6ef55aa1e39af87511eff6227c177f5ba97c50ca4c1e7cd8cc5cdc6b9086b0e38ab15ab94036c6eebe46b2f74101d3001d688c0103ecf42a8d40d8a410ddc50b0b98425408e3e606c41ac05db9c90e8197db2a2c131fdf26006b5ea2aaa0786b51eac252d5a428c18fc1c2c55a98fc75b3a1e8f89301d3001c284801012bf865c8703e0c3bf380fce8bd7e34d58fdaaf57d17203625338ff91e2d6d4d0000302a09bc7a987000000008001027d33bc000000010100000000800000000000000065c3340d0000286f922e78c00000286f922e78d8ac97745d00081a9f022451200224501fc400000005000000000000002e706f00980000286f921f369c027d33bb863fdf6f8b28aa8dde268c2bd7d53f743508299135872dc08595529511c3f469c61f3d34b73e081fef5af0c33c660293a6ef93b86ba149f8d6b07bab494d3bf500980000286f9200b20402245120f15b1ab07b52f36e9455d07f3bbaeaeb816fa8624539d4040fc632b80359686ced6506f6a195c77261a59c7b47f0c277e05ca7947a2affec9f5a76c8d686c8a7")?),
                out_msgs: Default::default(),
            },
            total_fees: CurrencyCollection::new(7649008u32),
            state_update: HashUpdate {
                old: TonHash::from_str("8a6b30a651f00953fe9e2cc8b5b3c6e194eb1caf44be8b6fc80ddccf1980b9a5")?,
                new: TonHash::from_str("887fb9f09b4dac4a0047f4ab6084eb7a3bb3dd7719bb483cf408d0dc98c8a506")?,
            },
            descr: TxDescrOrd::from_boc_hex("b5ee9c720101030100900002170c420900bebc20186e96dd110201005bc00000000000000000000000012d452da449e50b8cf7dd27861f146122afe1b546bb8b70fc8216f0c614139f8e04009c43bc2b0d4000000000000000014800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000")?.into(),
        };
        assert_eq!(tx, expected);
        assert_eq!(
            tx.cell_hash()?,
            TonHash::from_str("aa9ca4bad904121dbc01db9526e172b49c7880d2a54fc5b8a7feee177c14ee33")?
        );
        Ok(())
    }

    #[test]
    fn test_tx_c62815eb0c7f23859d3305ec54c83a49656a9a9e8a1311af7a39ea84b649f8cb() -> anyhow::Result<()> {
        // https://tonviewer.com/transaction/c62815eb0c7f23859d3305ec54c83a49656a9a9e8a1311af7a39ea84b649f8cb
        let tx = Tx::from_boc_hex("b5ee9c7201020b010002a40003b5781d0f4131eb92a164ee18b98d82dd4f1471bd68ddd863b452d9f2047b3fcab03000034300f0413c1ff8d83b19977e270bf32805828a07cf407f593570b4afc3001efeef4edd663a7000034300e1f3201682ca8ae00034645b1b68050401020f0c424618a18604400302006fc98399e04c099a480000000000020000000000039f3271f9a444ddb44247bd7143dea16918d2c3ab44ec354eec9a157c44b997c04090224c009d419d83138800000000000000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200082724f5c64bd2e6288c78527a0af4f6b4f2715f65033334f8c7dc3e48d5d2718257ffd669dbf3da1cb7ece6a54736930b993242004a50f0b80a23653fb57587863d60201e008060101df0701ff480103a1e8263d72542c9dc31731b05ba9e28e37ad1bbb0c768a5b3e408f67f9560700102368eca2db0196964f840e449a6eaaa717e32baf031a767c2aaeeacaa6495ad3a8fc2a0006099a5c000068601e082784d059515c000000002a32b632b3b930b690283932b6b4bab6903337b910199036b7b73a34399005052932b3400a01e1880103a1e8263d72542c9dc31731b05ba9e28e37ad1bbb0c768a5b3e408f67f956060754a2ff10d738bafbf61d29534c3892e0de8e2eaa190741f4215e430e2444b23be08d3651b9a9c7245ae0f70ac84d5e5c9f34a4d6d6b47fcf4532eca54dd878094d4d18bb4165491800025cb8001c0901b642002046d1d945b6032d2c9f081c8934dd554e2fc6575e0634ecf8555dd5954c92b5a751f85400000000000000000000000000000000000054656c656772616d205072656d69756d20666f722033206d6f6e746873200a0a5265660a001423564a37766956687772")?;
        assert_eq!(
            tx.cell_hash()?,
            TonHash::from_str("c62815eb0c7f23859d3305ec54c83a49656a9a9e8a1311af7a39ea84b649f8cb")?
        );
        Ok(())
    }

    #[test]
    fn test_some_tx1() -> anyhow::Result<()> {
        let tx = Tx::from_boc_hex("b5ee9c7201021c010003c40003af781e054b7619da2019f9107407bbb0c62d100016ad260289875ee2e29ee5e1a07000034382fdfa98300000000000000000000000000000000000000000000000000000000000000000000000000000000682de3e90001808030201000f0c0900b298ae452000827290aec8965afabb16ebc3cb9b408ebae71b618d78788bc80d09843593cac98da43e0f9f64d754df0cfa60e9526ce1312c2fd01e643cc8e4e46c24d363b628921f0101a00402b1480162aef1517dbd2ed3e5b21cdfc528e98e50096e6fd5d7f8d6df6fddc0e69754cd002078152dd867688067e441d01eeec318b440005ab4980a261d7b8b8a7b978681d00b298ae40643344e000068705fbf5304d05bc7d3e00605000c00000000486902013408070051800000003fffff88bdea79852c24375300dafa6f61f5709907af0969a7ebf0fc5faea89c98b599cca00114ff00f4a413f4bcf2c80b090201200c0a0102f20b011e20d70b1f82107369676ebaf2e08a7f17020148160d0201200f0e0019be5f0f6a2684080a0eb90fa02c020120131002014812110011b262fb513435c280200017b325fb51341c75c875c2c7e002016e15140019af1df6a2684010eb90eb858fc00019adce76a2684020eb90eb85ffc002dcd020d749c120915b8f6320d70b1f2082106578746ebd21821073696e74bdb0925f03e082106578746eba8eb48020d72101d074d721fa4030fa44f828fa443058bd915be0ed44d0810141d721f4058307f40e6fa1319130e18040d721707fdb3ce03120d749810280b99130e070e2181701e68ef0eda2edfb218308d722028308d723208020d721d31fd31fd31fed44d0d200d31f20d31fd3ffd70a000af90140ccf9109a28945f0adb31e1f2c087df02b35007b0f2d0845125baf2e0855036baf2e086f823bbf2d0882292f800de01a47fc8ca00cb1f01cf16c9ed542092f80fde70db3cd81803f6eda2edfb02f404216e926c218e4c0221d73930709421c700b38e2d01d72820761e436c20d749c008f2e09320d74ac002f2e09320d71d06c712c2005230b0f2d089d74cd7393001a4e86c128407bbf2e093d74ac000f2e093ed55e2d20001c000915be0ebd72c08142091709601d72c081c12e25210b1e30f20d74a1b1a190010935bdb31e1d74cd0007230d72c08248e2d21f2e092d200ed44d0d2005113baf2d08f54503091319c01810140d721d70a00f2e08ee2c8ca0058cf16c9ed5493f2c08de2009601fa4001fa44f828fa443058baf2e091ed44d0810141d718f405049d7fc8ca0040048307f453f2e08b8e14038307f45bf2e08c22d70a00216e01b3b0f2d090e2c85003cf1612f400c9ed54")?;
        assert_eq!(
            tx.cell_hash()?,
            TonHash::from_str("24A257B69427619CF6B1231DE26F135297CB4B8593BAF11FAE0C523F3546634C")?
        );
        Ok(())
    }

    #[test]
    fn test_tx_with_out_msgs() -> anyhow::Result<()> {
        let tx = Tx::from_boc_hex("b5ee9c72010211010003b50003b57b5e7a04218eb7a8c51566569c7dda1208aa8960c4d94b336c2a264885e53997d0000349c8088ee01b032c0002d268d2d7b7efcf1e74b10b999c192ed1469a13c10929e819f2666390000349831e89741683d3a8900054617b28a8050401021904818d8901718a581860c350110302006fc98894e04c16e23c000000000006000200000004feaa654872436fadddedc0fbb5ddcaae7a3ba55bd50592a0450237a6d6ededda40d04494009e407d0c0ec81800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008272dd89e6f278883b86386fa3d93e037b16b0680df01d8d5bc4be0d0d2db9654adfdd083c884d96b7890bbb99c04a66ff2c321d924bca98421ff518e17948765d910201e00c060201dd09070101200800c948016bcf408431d6f518a2accad38fbb424115512c189b29666d8544c910bca732fb00367bda8f3760396ff69c03d834faf87b1f01ba8e126154eab3f51597c20227df9016bb7ba40608235a000069390111dc06d07a75126a993b6dae7f7855da0ea340400101200a01ab48016bcf408431d6f518a2accad38fbb424115512c189b29666d8544c910bca732fb00367bda8f3760396ff69c03d834faf87b1f01ba8e126154eab3f51597c20227df8404060ebf08000069390111dc04d07a7512c00b00b27362d09c5cfef0abb41d4680398968080146662d4deb222048f1b2698e03230b2c77116b106efac9c7f27149ad464d7e3c0000000034303830323331382d343038632d346137332d383466342d39653564396165313039323202b16801b2c2d620bc0bc41c55a52d30061295300863268418d73cc49d339a7ef373a369002d79e810863adea31455995a71f7684822aa258313652ccdb0a899221794e65f501718a580061a0ee4000069390097ca04d07a7507e00e0d00f7178d45195cfef0abb41d4680398968080146662d4deb222048f1b2698e03230b2c77116b106efac9c7f27149ad464d7e3d00367bda8f3760396ff69c03d834faf87b1f01ba8e126154eab3f51597c20227df84040000000068607060646662705a686070c65a68c26e665a7068cc685a72ca6ac872c2ca6260726465020134100f008700801b3ded479bb01cb7fb4e01ec1a7d7c3d8f80dd470930aa7559fa8acbe10113efd002c44ea652d4092859c67da44e4ca3add6565b0e2897d640a2c51bfb370d8877fa0842028f452d7a4dfd74066b682365177259ed05734435be76b5fd4bd5d8af2b7c3d68")?;
        assert_eq!(
            tx.cell_hash()?,
            TonHash::from_str("2afaee90416232498a9487d882eadbeb9db71743e492e68f750375f05ea9b202")?,
            "{tx:?}"
        );
        Ok(())
    }
}
